<!DOCTYPE html>
<html lang="en">
<head>
  <title>Schedule Me!</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    const parseJSON = (xhr, content) => {
        
        const obj = JSON.parse(xhr.response);
        console.dir(obj);
        
        if(obj.message){
            const p = document.createElement('p');
            p.textContent = `Message: ${obj.message}`;
            content.appendChild(p);
        }
        
        if(obj.reminders){
            const reminderList = document.createElement('p');
            const reminders = JSON.stringify(obj.reminders);
            reminderList.textContent = reminders;
            content.appendChild(reminderList);
        }
        
        if(obj.tempReminders){
            const reminderList = document.createElement('p');
            const reminders = JSON.stringify(obj.tempReminders);
            reminderList.textContent = reminders;
            content.appendChild(reminderList);
        }
    };

    const handleResponse = (xhr, parseResponse) => {
        const content = document.querySelector('#content');
        
        switch(xhr.status){
            case 200:
                content.innerHTML = `<b>Success</b>`;
                break;
            case 201: 
                content.innerHTML = `<b>Create</b>`;
                break;
            case 204: 
                content.innerHTML = `<b>Updated (No Content)</b>`;
                break;
            case 400: 
                content.innerHTML = `<b>Bad Request</b>`
                break;
            case 404:
                content.innerHTML = `<b>Resource Not Found</b>`;
                break;
            default:
                content.innerHTML = 'Error code not implemented by client';
                break;
        }
        
        if(xhr.status != 204 && parseResponse){
            parseJSON(xhr, content);
        }
        
        else{
            console.log('received')
        }
    };

    const sendPost = (e, reminderForm) => {
        const reminderAction = reminderForm.getAttribute('action');
        const reminderMethod = reminderForm.getAttribute('method');
        
        const nameField = reminderForm.querySelector('#nameField');
        const descriptionField = reminderForm.querySelector('#descriptionField');
        const tagField = reminderForm.querySelector('#tagField');
        
        const xhr = new XMLHttpRequest();
        xhr.open(reminderMethod, reminderAction);
        
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('Accept', 'application/json');
        
        xhr.onload = () => handleResponse(xhr, true);
        
        const formData = `name=${nameField.value}&description=${descriptionField.value}&tag=${tagField.value}`;
        
        xhr.send(formData);
        
        e.preventDefault();
        
        return false;
    };

    const sendGet = (e, getReminderForm) => {
        const userMethod = getReminderForm.getAttribute('method');       
        const urlField = getReminderForm.querySelector('#reminderType');  
        
        const searchField = getReminderForm.querySelector('#searchField');
        
        const xhr = new XMLHttpRequest();
        
        xhr.open("GET" , `${urlField.value}&field=${searchField.value}`);
        
        xhr.setRequestHeader('Accept', 'application/json');
        
        //True means we're looking for get
        xhr.onload = () => handleResponse(xhr, true);

        xhr.send();
        
        e.preventDefault();
        
        return false;
    };

    const sendHead = (e, getExistForm) => {
        const userMethod = getExistForm.getAttribute('method');
        const urlField = getExistForm.querySelector('#nameField');
        const xhr = new XMLHttpRequest();
        console.dir(urlField.value);
        xhr.open("HEAD", urlField.value);
        
        xhr.setRequestHeader('Accept', 'application/json');
        
        //false for head
        xhr.onload = () => handleResponse(xhr, false);
        
        xhr.send();
        e.preventDefault();
        return false;
    }

    const init = () => {
        const reminderForm = document.querySelector('#submitReminderForm'); 
        const addReminder = (e) => sendPost(e, reminderForm); 
        reminderForm.addEventListener('submit', addReminder);

        const getForm = document.querySelector('#getRemindersForm');
        const getReminders = (e) => sendGet(e, getForm);
        getForm.addEventListener('submit', getReminders);
        
        const checkForm = document.querySelector('#checkReminderExists');
        const checkReminder = (e) => sendHead(e, checkForm);
        checkForm.addEventListener('submit', checkReminder);
    };
    
    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h3>Remind Me!</h3>
      
    <form id="submitReminderForm" action="/submitReminder" method="post">
      <label for="name">Reminder Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="description">Description: </label>
      <input id="descriptionField" type="text" name="description" />
        <label for="tag">Tag: </label>
        <input id="tagField" type="text" name="tag"/>
      <input type="submit" value="Add Reminder" />
    </form>
      
    <form id="getRemindersForm" action="/getReminder" method="get">
        <select id='reminderType'>
            <option value='/getAllReminders'>All Reminders</option>
            <option value='/getByTag'>Tag</option>
            <option value='/getByName'>Name</option>
        </select>
        <input id="searchField" type="text" name="search"/>
        <input type="submit" value="Get Reminders"/>
    </form>
      
    <form id="checkReminderExists" action="/checkReminder" method="head">
        <label for="name">Reminder Name:</label>
        <input id="nameField" type="text" name="name"/>
        <input type="submit" value="Check if Reminder Exists"/>
    </form>

  </section>
  <section id="content">
  </section>
</body>
</html>