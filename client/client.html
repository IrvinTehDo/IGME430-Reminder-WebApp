<!DOCTYPE html>
<html lang="en">
<head>
  <title>Schedule Me!</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">
    
    const makeNotificationBox = (obj, content) => {
        console.log('Makng a notification box');
        console.dir(obj);
        
        const item = document.createElement('div');
        const name = document.createElement('h4');
        name.textContent = `Name: ${obj.name}`;
        const tag = document.createElement('p');
        tag.textContent = `Tag: ${obj.tag}`;
        const description = document.createElement('p');
        description.textContent = `Description: ${obj.description}`;
        const date = document.createElement('p');
        
        let countFrom = new Date(obj.date).getTime();
        
        let countdown = setInterval(() => {
            var curTime = new Date().getTime();
            var length = countFrom - curTime;
            
            var d = Math.floor(length/(1000*60*60*24));
            var h = Math.floor((length %(1000*60*60*24))/ (1000*60*60));
            var m = Math.floor((length %(1000*60*60)) / (1000 * 60));
            var s = Math.floor((length % (1000*60))/ 1000);
            
            date.textContent = `${d} Days ${h} Hours ${m} Min ${s} Sec`;
            
            if(length < 0){
                clearInterval(countdown);
                date.textContent = "EXPIRED";
            }
            
        }, 1000)

        //date.textContent = `${obj.date}`;
        
        item.appendChild(name);
        item.appendChild(tag);
        item.appendChild(description);
        item.appendChild(date);
        content.appendChild(item);
    };

    const parseJSON = (xhr, status) => {
        const content = document.querySelector('#content');
        const obj = JSON.parse(xhr.response);
        console.dir(obj);
        
        if(obj.message){
            const p = document.createElement('p');
            p.textContent = `Message: ${obj.message}`;
            status.appendChild(p);
        }
        //When user requested "all reminders"
        if(obj.reminders){
            content.innerHTML = "";
            const keys = Object.keys(obj.reminders);
            
            Object.entries(obj.reminders).forEach(
                ([key, value]) => {
                    //console.dir(value);
                    makeNotificationBox(value, content);
                    
                });

        }
        //Temp Reminders is what the user searched for that's not "all reminders"
        if(obj.tempReminders){
            content.innerHTML = "";
            const keys = Object.keys(obj.tempReminders);
            
            Object.entries(obj.tempReminders).forEach(
                ([key, value]) => makeNotificationBox(value, content)
            );
        }
    };

    const handleResponse = (xhr, parseResponse) => {
        //const content = document.querySelector('#content');
        const status = document.querySelector('#status');
        
        switch(xhr.status){
            case 200:
                //content.innerHTML = `<b>Success</b>`;
                status.innerHTML = `<b>Success</b>`
                break;
            case 201: 
                //content.innerHTML = `<b>Create</b>`;
                status.innerHTML = `<b>Create</b>`;
                break;
            case 204: 
                //content.innerHTML = `<b>Updated (No Content)</b>`;
                status.innerHTML = `<b>Updated (No Content)</b>`;
                break;
            case 400: 
                status.innerHTML = `<b>Bad Request</b>`
                break;
            case 404:
                status.innerHTML = `<b>Resource Not Found</b>`;
                break;
            default:
                status.innerHTML = 'Error code not implemented by client';
                break;
        }
        
        if(xhr.status != 204 && parseResponse){
            parseJSON(xhr, status);
        }
        
        else{
            console.log('received')
        }
    };

    const sendPost = (e, reminderForm) => {
        const reminderAction = reminderForm.getAttribute('action');
        const reminderMethod = reminderForm.getAttribute('method');
        
        const nameField = reminderForm.querySelector('#nameField');
        const descriptionField = reminderForm.querySelector('#descriptionField');
        const tagField = reminderForm.querySelector('#tagField');
        const dateField = reminderForm.querySelector('#dateField');
        
        const xhr = new XMLHttpRequest();
        xhr.open(reminderMethod, reminderAction);
        
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('Accept', 'application/json');
        
        xhr.onload = () => handleResponse(xhr, true);
        
        const formData = `name=${nameField.value}&description=${descriptionField.value}&tag=${tagField.value}&date=${dateField.value}`;
        
        xhr.send(formData);
        
        e.preventDefault();
        
        return false;
    };

    const sendGet = (e, getReminderForm) => {
        const userMethod = getReminderForm.getAttribute('method');       
        const urlField = getReminderForm.querySelector('#reminderType');  
        
        const searchField = getReminderForm.querySelector('#searchField');
        
        const xhr = new XMLHttpRequest();
        
        xhr.open("GET" , `${urlField.value}&field=${searchField.value}`);
        
        xhr.setRequestHeader('Accept', 'application/json');
        
        //True means we're looking for get
        xhr.onload = () => handleResponse(xhr, true);

        xhr.send();
        
        e.preventDefault();
        
        return false;
    };

    const sendHead = (e, getExistForm) => {
        const userMethod = getExistForm.getAttribute('method');
        const urlField = getExistForm.querySelector('#nameField');
        const xhr = new XMLHttpRequest();
        console.dir(urlField.value);
        xhr.open("HEAD", urlField.value);
        
        xhr.setRequestHeader('Accept', 'application/json');
        
        //false for head
        xhr.onload = () => handleResponse(xhr, false);
        
        xhr.send();
        e.preventDefault();
        return false;
    }

    const init = () => {
        const reminderForm = document.querySelector('#submitReminderForm'); 
        const addReminder = (e) => sendPost(e, reminderForm); 
        reminderForm.addEventListener('submit', addReminder);

        const getForm = document.querySelector('#getRemindersForm');
        const getReminders = (e) => sendGet(e, getForm);
        getForm.addEventListener('submit', getReminders);
        
        const checkForm = document.querySelector('#checkReminderExists');
        const checkReminder = (e) => sendHead(e, checkForm);
        checkForm.addEventListener('submit', checkReminder);
    };
    
    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
      <div id="statusContainer"><h2 id="status"></h2></div>
    <h3>Remind Me!</h3>
      
    <form id="submitReminderForm" action="/submitReminder" method="post">
      <label for="name">Reminder Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="description">Description: </label>
      <input id="descriptionField" type="text" name="description" />
        <label for="tag">Tag: </label>
        <input id="tagField" type="text" name="tag"/>
        <label for="date">Date: </label>
        <input id="dateField" type="datetime-local" name="date"/>
      <input type="submit" value="Add Reminder" />
    </form>
      
    <form id="getRemindersForm" action="/getReminder" method="get">
        <select id='reminderType'>
            <option value='/getAllReminders'>All Reminders</option>
            <option value='/getByTag'>Tag</option>
            <option value='/getByName'>Name</option>
        </select>
        <input id="searchField" type="text" name="search"/>
        <input type="submit" value="Get Reminders"/>
    </form>
      
    <form id="checkReminderExists" action="/checkReminder" method="head">
        <label for="name">Reminder Name:</label>
        <input id="nameField" type="text" name="name"/>
        <input type="submit" value="Check if Reminder Exists"/>
    </form>

  </section>
  <section id="content">
  </section>
</body>
</html>